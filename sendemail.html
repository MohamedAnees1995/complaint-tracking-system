{% extends "master.html" %}


{% block styles %}
<!-- <script src="https://cdn.ckeditor.com/ckeditor5/36.0.1/classic/ckeditor.js"></script> -->
<style>
    /* Custom styles for the form */
.container {
    max-width: 100vw;
    margin: 10px auto;
    padding: 0 15px;
    max-height: 500px;  /* Decrease the height of the container */
}


.form-container {
    background-color: #fff;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    height: 50%;  /* Ensure it takes up the full height within container */
}


.form-title {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 20px;
    color: #333;
    text-align: center;
}


.form-group {
    margin-bottom: 20px;
}


label {
    font-weight: 500;
    color: #333;
}


.btn-primary {
    background-color: #0e3152;
    border-color: #0e3152;
    padding: 10px 28px;
    display: block;
    border-radius: 4px;
    font-size: 16px;
    color: white;
    margin-top: 20px;
    margin-left: auto;
    margin-right: auto;
}


.btn-primary:hover {
    background-color: #0e3152;
    border-color: #0e3152;
}


.form-control {
    font-size: 16px;
    padding: 12px;
    border-radius: 4px;
    width: 100%;
}


.textarea-control {
    resize: none;
    height: 350px;
}


.form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}


.form-row .form-group {
    flex: 1;
    min-width: 280px;
}


@media (max-width: 768px) {
    .container {
        padding: 0 20px;
    }


    .form-row {
        flex-direction: column;
    }


    .btn-primary {
        margin-left: 0;
    }


    .textarea-control {
        height: 200px;
    }
}


/* CKEditor height adjustments */
.ck.ck-editor__main>.ck-editor__editable:not(.ck-focused) {
    border-color: var(--ck-color-base-border);
    height: 150px !important;
}


.ck.ck-editor__main {
    height: 150px;
}


.ck-focused {
    height: 150px !important;
}


.form-group.text-center {
    margin-top: 20px; /* Ensure button has some space below the CKEditor */
}



    .btn-cancel {
        background-color: #0e3152;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 16px;
        margin-left: 610px;
        text-decoration: none;
    }


    .btn-cancel:hover {
        background-color: #0e3152;
    }
    .table-container {
        max-width: 100vw;
        margin: auto;
        margin-bottom: 40px;
        border-radius: 5px;
        padding: 20px;
        height: auto;
        min-height: 250px;
        box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
        background-color: transparent;
    }


    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        margin-right: 10px;
    }


    th, td {
        padding: 10px;
        text-align: left;
    }


    th {
        background-color: #f4f4f4;
        color: #333;
        font-weight: bold;
    }


    .action-icons {
        display: flex;
        gap: 10px;
    }


    .btn {
        margin-bottom: -200px;
        padding: 12px 17px;
        text-decoration: none;
        border-radius: 5px;
        font-size: 14px;
        width: 80px;
    }


    .btn-warning {
        background-color: #0e3152;
        color: white;
    }


    .btn-danger {
        background-color: #f44336;
        color: white;
    }


    .btn:hover {
        opacity: 0.8;
    }


    .no-data {
        text-align: center;
        font-style: italic;
        color: #888;
    }


    .dropdown {
        position: relative;
    }


    #days_dropdown {
        display: none;
        position: absolute;
        background-color: white;
        border: 1px solid #ddd;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        z-index: 10;
    }


    #days_dropdown li {
        padding: 10px;
        cursor: pointer;
    }


    #days_dropdown li:hover {
        background-color: #f4f4f4;
    }


    @media screen and (max-width: 768px) {
        .form-row {
            flex-direction: column;
        }


        .form-group {
            margin-bottom: 15px;
        }


        .btn {
            font-size: 12px;
        }
    }


    .form-group {
        position: relative;
    }


    .placeholder {
        position: absolute;
        top: 50%;
        left: 10px;
        font-size: 20px;
        transform: translateY(-50%);
        color: #837a7a;
        margin-top: 5px;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }


    .form-control:focus + .placeholder {
        display: none;  /* Hide placeholder on focus */
    }


    h2 {
        margin-left: 50px;
        font-size: 30px;
        margin-top: -27px;
    }


    .form-group select, .form-group input {
    font-size: 1.1em;
    padding: 10px;
    height: 50px;
    width: 100%; /* Ensure both inputs take up the same width */
    box-sizing: border-box; /* This ensures the padding does not affect the width */
}


.form-group select {
    -webkit-appearance: none; /* Remove default styling in some browsers */
    -moz-appearance: none;
    appearance: none;
    padding-right: 30px; /* Add padding to the right for the dropdown arrow */
}


/* Style the select dropdown */
.form-group select {
    font-size: 1.1em;
    padding: 10px;
    height: 50px;
    width: 100%;
    box-sizing: border-box;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
}


/* Optional: Add some padding to the right if you plan to display custom dropdown arrows */
.form-group select {
    padding-right: 40px;
}


.action-btn {
    padding: 5px 10px;
    font-size: 14px;
    font-weight: bold;
    border-radius: 5px;
    text-align: center;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    display: inline-block;
}


.edit-btn {
    background-color: #0e3152;  /* Green for Edit */
    color: white;
    border: 1px solid #0e3152;
}


.delete-btn {
    background-color: #f44336;  /* Red for Delete */
    color: white;
    border: 1px solid #f44336;
}


.edit-btn:hover {
    background-color: #0e3152;
    transform: translateY(-2px);  /* Slight upward movement on hover */
}


.delete-btn:hover {
    background-color: #f44336;
    transform: translateY(-2px);  /* Slight upward movement on hover */
}


.edit-btn:active,
.delete-btn:active {
    transform: translateY(1px);  /* Slight downward movement on click */
}


.edit-btn:focus,
.delete-btn:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.3);
}



h2{
    margin-left: 50px;
    margin-bottom: 33px;
    font-size: 30px;
    margin-top: -27px;
}

.form-field-line {
    border: none;
    border-bottom: 2px solid #ccc;
    outline: none;
    width: 100%;
    padding: 5px 0;
    font-size: 16px;
    background-color: transparent;
    transition: border-color 0.3s ease;
}

.form-field-line:focus {
    border-bottom: 2px solid #007bff; /* Highlight color when focused */
}

.form-field-line::placeholder {
    color: #aaa;
    font-style: italic;
}
</style>
{% endblock %}


{% block content %}
<h2 style="font-family:  'Times New Roman', ;">Canned Messages</h2>
<div class="container">
    <div class="form-container">
        <div class="form-title"></div>
        <!-- Form Starts -->
        <form action="{% url 'sendemail' %}" enctype="multipart/form-data" method="POST" id="complaintForm">
            {% csrf_token %}
            <div class="form-row">
                <!-- Department Dropdown -->
                <div class="form-group">
                    <label for="department"></label>
                    <select id="department" name="department" class="form-control form-field-line" required>
                        <option value="">Select Department</option>
                        {% for department in departments %}
                            <option value="{{ department.0 }}">{{ department.0 }}</option>
                        {% endfor %}
                    </select>
                </div>


                <!-- Complaint Type Dropdown -->
                    <div class="form-group">
                        <label for="complaint_type"></label>
                        <select id="complaint_type" name="complaint_type" class="form-control form-field-line" required>
                            <option value="">Select Complaint Type</option>
                            <!-- {% for complaint_type in complaint_types %}
                                <option value="{{ complaint_type.1 }}">{{ complaint_type.1 }}</option>
                            {% endfor %} -->
                        </select>
                    </div>
                </div>
             

                <div class="form-group">
                    <!-- <label for="signature">Select a Signature</label> -->
                    <select id="signature" name="signature" class="form-control form-field-line" required>
                        <option value="">Select Signature</option>
                        {% for signature in signatures %}
                            <option value="{{ signature.html|safe }}">{{ signature.html|safe }}</option>
                        {% endfor %}
                    </select>
                </div>


            <!-- CKEditor Email Field -->
            <div class="form-group">
                <label for="email"></label>
                <textarea name="email" style="visibility: visible;" id="email" class="form-control textarea-control"
                    rows="5" placeholder="Enter Your Message......."></textarea>
            </div>


            <div class="form-group text-center" style="margin-bottom: 200px;">
                <button type="submit" class="btn btn-primary" id="submitBtn" style="cursor: pointer;">Add</button>
            </div>
        </form>
        <!-- Form Ends -->
    </div>


    <div class="table-container">
        <table id="complaintTypesTable" class="display" >
            <thead>
                <tr>
                    <th>Department</th>
                    <th>Complaint Type</th>
                    <th>Message</th>
                    <th>Signature</th>
                    <th >Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for complaint in complaints %}
                <tr  data-id="{{complaint.0}}" >
                    <td>{{ complaint.1 }}</td>
                    <td>{{ complaint.2 }}</td>
                    <td>{{ complaint.3|safe }}</td> <!-- Using safe to render HTML content -->
                    <td>{{ complaint.4|safe }}</td> <!-- Using safe to render HTML content -->
                    <td>
                        <button class="action-btn edit-btn" onclick="editComplaint({{ complaint.0 }})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteComplaint({{ complaint.0 }})">Delete</button>
                
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}


{% block script %}


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>


<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">


<!-- DataTables Buttons CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">


<!-- DataTables Buttons JS -->
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>


<!-- JSZip for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>


<!-- PDFMake for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/36.0.1/classic/ckeditor.js"></script>


<script>
    $(document).ready(function() {
        // Initialize DataTable
        $('#complaintTypesTable').DataTable({
            "paging": true,           // Enable pagination
            "lengthChange": true,     // Enable records per page selection
            "searching": true,        // Enable search functionality
            "ordering": true,         // Enable column sorting
            "info": true,             // Show information about the current page
            "autoWidth": false,       // Disable automatic column width adjustment
            "pageLength": 5,        // Set default records per page to 5
            "lengthMenu": [3, 5, 10, 25, 50, 100], // Set the records per page options
        });
    });

    $(document).ready(function() {
        $('#department').on('change', function() {
            var selectedDept = $(this).val();
            
            if (selectedDept) {
                $.ajax({
                    url: '{% url "getcomplainttypes" %}', // Django URL for the view
                    type: 'GET', // Ensure this is a GET request
                    data: {
                        'dept': selectedDept
                    },
                    success: function(response) {
                        var $complaintTypeSelect = $('#complaint_type');
                        $complaintTypeSelect.empty(); // Clear existing options
                        
                        // Add a default option
                        $complaintTypeSelect.append(
                            $('<option>', {
                                value: '',
                                text: 'Select Complaint Type'
                            })
                        );
    
                        // Populate with new options from response data
                        $.each(response.data, function(index, item) {
                            $complaintTypeSelect.append(
                                $('<option>', {
                                    value: item.complaint_type,
                                    text: item.complaint_type
                                })
                            );
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching complaint types:', error);
                    }
                });
            } else {
                // Reset complaint types if no department is selected
                $('#complaint_type').empty().append(
                    $('<option>', {
                        value: '',
                        text: 'Select Complaint Type'
                    })
                );
            }
        });
    });

    // Initialize CKEditor
    let editor;
    ClassicEditor
        .create(document.querySelector('#email'), {
            toolbar: [
                'heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote',
                '|', 'insertTable', 'tableColumn', 'tableRow', 'mergeTableCells', 
                '|', 'imageUpload', 'mediaEmbed', 'undo', 'redo', '|', 'signature'
            ],
            mediaEmbed: {
                previewsInData: true, // Allows embedded media previews in data
            },
            ckfinder: {
                uploadUrl: '/upload/' // Your backend URL for handling uploads
            }
        })
        .then(ed => {
            editor = ed;
        })
        .catch(error => {
            console.error(error);
        });


    // Function to strip HTML tags and return only plain text



// Handle form submission (for adding new complaints)
document.querySelector('#complaintForm').addEventListener('submit', function (event) {
    event.preventDefault();  // Prevent default form submission

    if(document.querySelector('#submitBtn').innerHTML == "Update") return false;  // Prevent form submission if in update mode

    // Ensure CKEditor content is updated to the textarea value
    if (editor) {
        let emailContent = editor.getData();
        // Strip the HTML tags (or keep it as HTML)
        let plainEmailContent = emailContent;
        document.querySelector('#email').value = plainEmailContent; // Set the stripped content to the textarea
    }

    // Validate the form
    const department = document.getElementById('department').value;
    const complaint_type = document.getElementById('complaint_type').value;
    const email = document.getElementById('email').value;
    const signature = document.getElementById('signature').value;  // Get the selected signature

    // Validate all fields
    if (department && complaint_type && email && signature) {
        submitFormViaAjax(department, complaint_type, email, signature);
    } else {
        alert('Please fill in all fields');
    }
});

// Submit form via AJAX (for adding new complaints)
const submitFormViaAjax = (department, complaint_type, email, signature) => {
    const url = '{% url "sendemail" %}';  // Ensure this URL is correct
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const formData = {
        department: department,
        complaint: complaint_type,
        message: email,
        signature: signature  // Add signature to the form data
    };

    // Perform the AJAX request
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',  // Send data as JSON
            'X-CSRFToken': csrfToken,  // CSRF protection
        },
        body: JSON.stringify(formData)  // Send data as JSON
    })
        .then(response => response.json())
        .then(data => {
            if (data.message === 'Complaint submitted successfully!') {
                alert('Complaint submitted successfully!');
                // Add the new complaint to the table dynamically
                addComplaintToTable(data.complaint);  // Ensure this is returned in the response
                document.getElementById('complaintForm').reset();
                editor.setData('');  // Clear CKEditor content
            } else {
                alert('There was an error submitting your complaint.');
            }
        })
        .catch(error => {
            console.log(error);
            console.error('Error during form submission:', error);
            alert('An error occurred while submitting the complaint.');
        });
};

// Function to add a complaint to the table dynamically after submission
function addComplaintToTable(complaint) {
    let tableBody = document.querySelector('#complaintTypesTable tbody');
    let newRow = document.createElement('tr');
    newRow.setAttribute('data-id', complaint.id); 
    newRow.innerHTML = `
        <td>${complaint.department}</td>
        <td>${complaint.complaint}</td>
        <td>${complaint.message}</td>
        <td>${complaint.signature}</td> <!-- Add signature to the table -->
        <td>
            <button class="action-btn edit-btn" onclick="editComplaint(${complaint.id})">Edit</button>
            <button class="action-btn delete-btn" onclick="deleteComplaint(${complaint.id})">Delete</button>
        </td>
    `;
    tableBody.appendChild(newRow);
}

// Function to edit a complaint (AJAX - PUT)
function editComplaint(id) {
    const url = `/editmail/${id}/`; // Your edit URL
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Get current row data
    let row = document.querySelector(`#complaintTypesTable tr[data-id="${id}"]`);
    const department = row.querySelector('td:nth-child(1)').textContent.trim();
    const complaintType = row.querySelector('td:nth-child(2)').textContent.trim();
    const signature = row.querySelector('td:nth-child(4)').textContent.trim(); // Assuming the signature is in the 4th column

    // Extract email content
    const row1 = document.querySelector(`tr[data-id="${id}"]`);
    const cells = row1.querySelectorAll('td');
    const emailMessage = Array.from(cells).map(cell => cell.innerHTML);
    const pTagContent = emailMessage[2];
    const parser = new DOMParser();
    const doc = parser.parseFromString(pTagContent, 'text/html');
    const pElements = doc.querySelectorAll('p');
    const alldata = Array.from(pElements).map(p => p.outerHTML);
    const content = alldata.join('');

    // Display current data in the form for editing
    document.getElementById('department').value = department;
    editor.setData(content); // Set CKEditor content

    // Fetch complaint types dynamically
    $.ajax({
        url: '{% url "getcomplainttypes" %}',
        type: 'GET',
        data: { dept: department },
        success: function (response) {
            const $complaintTypeSelect = $('#complaint_type');
            $complaintTypeSelect.empty();

            // Add a default option
            $complaintTypeSelect.append(
                $('<option>', {
                    value: '',
                    text: 'Select Complaint Type',
                })
            );

            // Populate with new options
            $.each(response.data, function (index, item) {
                $complaintTypeSelect.append(
                    $('<option>', {
                        value: item.complaint_type,
                        text: item.complaint_type,
                    })
                );
            });

            // Set the current complaint type after the options are loaded
            $complaintTypeSelect.val(complaintType);
        },
        error: function (xhr, status, error) {
            console.error('Error fetching complaint types:', error);
        },
    });

    // Prepopulate signature dropdown
    const $signatureSelect = $('#signature');
    $signatureSelect.val(''); // Reset any previously selected value

    // Loop through all the options in the signature dropdown and match the text content
    $signatureSelect.find('option').each(function() {
        if ($(this).text().trim() === signature) {
            $signatureSelect.val($(this).val());  // Set the matching value
            return false;  // Exit the loop once a match is found
        }
    });

    // Show the form for editing and change the submit button to "Update"
    document.querySelector('#complaintForm button[type="submit"]').textContent = 'Update';

    // Handle update via AJAX
    document.querySelector('#complaintForm').onsubmit = function (event) {
        event.preventDefault();

        const updatedEmail = editor.getData();
        const updatedSignature = document.getElementById('signature').value;  // Get the signature value
        const updatedData = {
            department: department,
            complaint: $('#complaint_type').val(),
            message: updatedEmail,
            signature: updatedSignature,  // Include the signature in the updated data
        };

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify(updatedData),
        })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'Complaint updated successfully!') {
                    alert('Complaint updated successfully!');
                    updateComplaintRow(id, updatedData);
                    document.getElementById('complaintForm').reset();
                    editor.setData('');
                } else {
                    alert('There was an error updating your complaint.');
                }
            })
            .catch(error => {
                console.error('Error during update:', error);
                alert('An error occurred while updating the complaint.');
            });
    };
}

// Function to update the complaint row in the table
function updateComplaintRow(id, updatedData) {
    const row = document.querySelector(`#complaintTypesTable tr[data-id="${id}"]`);
    row.querySelector('td:nth-child(1)').textContent = updatedData.department;
    row.querySelector('td:nth-child(2)').textContent = updatedData.complaint;
    row.querySelector('td:nth-child(3)').textContent = updatedData.message;
    row.querySelector('td:nth-child(4)').textContent = updatedData.signature;  // Update signature in the table
}

// Function to delete a complaint (AJAX - DELETE)
function deleteComplaint(id) {
    const url = `/delemail/${id}/`;  // Your delete URL
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (confirm('Are you sure you want to delete this complaint?')) {
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message === 'Complaint deleted successfully!') {
                alert('Complaint deleted successfully!');
                // Remove the deleted complaint from the table
                removeComplaintFromTable(id);
            } else {
                alert('There was an error deleting your complaint.');
            }
        })
        .catch(error => {
            console.error('Error during delete:', error);
            alert('An error occurred while deleting the complaint.');
        });
    }
}

// Function to remove a complaint row from the table
function removeComplaintFromTable(id) {
    const row = document.querySelector(`#complaintTypesTable tr[data-id="${id}"]`);
    row.remove();
}
</script>


{% endblock %}