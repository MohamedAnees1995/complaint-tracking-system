{% extends "master.html" %}


{% block styles %}
<!-- <script src="https://cdn.ckeditor.com/ckeditor5/36.0.1/classic/ckeditor.js"></script> -->
<style>
    /* Custom styles for the form */
.container {
    max-width: 100vw;
    margin: 10px auto;
    padding: 0 15px;
    max-height: 500px;  /* Decrease the height of the container */
}


.form-container {
    background-color: #fff;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    height: 50%;  /* Ensure it takes up the full height within container */
}


.form-title {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 20px;
    color: #333;
    text-align: center;
}


.form-group {
    margin-bottom: 20px;
}


label {
    font-weight: 500;
    color: #333;
}


.btn-primary {
    background-color: #0e3152;
    border-color: #0e3152;
    padding: 10px 28px;
    display: block;
    border-radius: 4px;
    font-size: 16px;
    color: white;
    margin-top: 20px;
    margin-left: auto;
    margin-right: auto;
}


.btn-primary:hover {
    background-color: #0e3152;
    border-color: #0e3152;
}


.form-control {
    font-size: 16px;
    padding: 12px;
    border-radius: 4px;
    width: 100%;
}


.textarea-control {
    resize: none;
    height: 350px;
}


.form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}


.form-row .form-group {
    flex: 1;
    min-width: 280px;
}


@media (max-width: 768px) {
    .container {
        padding: 0 20px;
    }


    .form-row {
        flex-direction: column;
    }


    .btn-primary {
        margin-left: 0;
    }


    .textarea-control {
        height: 200px;
    }
}


/* CKEditor height adjustments */
.ck.ck-editor__main>.ck-editor__editable:not(.ck-focused) {
    border-color: var(--ck-color-base-border);
    height: 150px !important;
}


.ck.ck-editor__main {
    height: 150px;
}


.ck-focused {
    height: 150px !important;
}


.form-group.text-center {
    margin-top: 20px; /* Ensure button has some space below the CKEditor */
}



    .btn-cancel {
        background-color: #0e3152;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 16px;
        margin-left: 610px;
        text-decoration: none;
    }


    .btn-cancel:hover {
        background-color: #0e3152;
    }
    .table-container {
        max-width: 100vw;
        margin: auto;
        margin-bottom: 40px;
        border-radius: 5px;
        padding: 20px;
        height: auto;
        min-height: 250px;
        box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
        background-color: transparent;
    }


    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        margin-right: 10px;
    }


    th, td {
        padding: 10px;
        text-align: left;
    }


    th {
        background-color: #f4f4f4;
        color: #333;
        font-weight: bold;
    }


    .action-icons {
        display: flex;
        gap: 10px;
    }


    .btn {
        margin-bottom: -200px;
        padding: 12px 17px;
        text-decoration: none;
        border-radius: 5px;
        font-size: 14px;
        width: 80px;
    }


    .btn-warning {
        background-color: #0e3152;
        color: white;
    }


    .btn-danger {
        background-color: #f44336;
        color: white;
    }


    .btn:hover {
        opacity: 0.8;
    }


    .no-data {
        text-align: center;
        font-style: italic;
        color: #888;
    }


    .dropdown {
        position: relative;
    }


    #days_dropdown {
        display: none;
        position: absolute;
        background-color: white;
        border: 1px solid #ddd;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        z-index: 10;
    }


    #days_dropdown li {
        padding: 10px;
        cursor: pointer;
    }


    #days_dropdown li:hover {
        background-color: #f4f4f4;
    }


    @media screen and (max-width: 768px) {
        .form-row {
            flex-direction: column;
        }


        .form-group {
            margin-bottom: 15px;
        }


        .btn {
            font-size: 12px;
        }
    }


    .form-group {
        position: relative;
    }


    .placeholder {
        position: absolute;
        top: 50%;
        left: 10px;
        font-size: 20px;
        transform: translateY(-50%);
        color: #837a7a;
        margin-top: 5px;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }


    .form-control:focus + .placeholder {
        display: none;  /* Hide placeholder on focus */
    }


    h2 {
        margin-left: 50px;
        font-size: 30px;
        margin-top: -27px;
    }


    .form-group select, .form-group input {
    font-size: 1.1em;
    padding: 10px;
    height: 50px;
    width: 100%; /* Ensure both inputs take up the same width */
    box-sizing: border-box; /* This ensures the padding does not affect the width */
}


.form-group select {
    -webkit-appearance: none; /* Remove default styling in some browsers */
    -moz-appearance: none;
    appearance: none;
    padding-right: 30px; /* Add padding to the right for the dropdown arrow */
}


/* Style the select dropdown */
.form-group select {
    font-size: 1.1em;
    padding: 10px;
    height: 50px;
    width: 100%;
    box-sizing: border-box;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
}


/* Optional: Add some padding to the right if you plan to display custom dropdown arrows */
.form-group select {
    padding-right: 40px;
}


.action-btn {
    padding: 5px 10px;
    font-size: 14px;
    font-weight: bold;
    border-radius: 5px;
    text-align: center;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    display: inline-block;
}


.edit-btn {
    background-color: #0e3152;  /* Green for Edit */
    color: white;
    border: 1px solid #0e3152;
}


.delete-btn {
    background-color: #f44336;  /* Red for Delete */
    color: white;
    border: 1px solid #f44336;
}


.edit-btn:hover {
    background-color: #0e3152;
    transform: translateY(-2px);  /* Slight upward movement on hover */
}


.delete-btn:hover {
    background-color: #f44336;
    transform: translateY(-2px);  /* Slight upward movement on hover */
}


.edit-btn:active,
.delete-btn:active {
    transform: translateY(1px);  /* Slight downward movement on click */
}


.edit-btn:focus,
.delete-btn:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.3);
}



h2{
    margin-left: 50px;
    margin-bottom: 33px;
    font-size: 30px;
    margin-top: -27px;
}
</style>
{% endblock %}


{% block content %}
<h2 style="font-family: 'Times New Roman';">Email Signatures</h2>
<div class="container">
    <div class="form-container">
        <div class="form-title"></div>
        <!-- Form Starts -->
        <form action="{% url 'signaturemaster' %}" enctype="multipart/form-data" method="POST" id="complaintForm">
            {% csrf_token %}
            <div class="form-row">
                <!-- Name Input Box -->
                <div class="form-group">
                    <label for="name">Name</label>
                    <input
                        id="name"
                        name="name"
                        class="form-control"
                        type="text"
                        placeholder="Enter Name"
                        required
                    />
                </div>
            </div>

            <!-- CKEditor Email Field -->
            <div class="form-group">
                <label for="email">Email Signature</label>
                <textarea name="email" style="visibility: visible;" id="email" class="form-control textarea-control"
                    rows="5" placeholder="Enter Your Message......."></textarea>
            </div>

            <div class="form-group text-center" style="margin-bottom: 200px;">
                <button type="submit" class="btn btn-primary" id="submitBtn" style="cursor: pointer;">Add</button>
            </div>
        </form>
        <!-- Form Ends -->
    </div>

    <!-- Table to display complaints -->
    <div class="table-container">
        <table id="complaintTypesTable" class="display">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Signature</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for complaint in complaints %}
                <tr data-id="{{ complaint.0 }}">
                    <td>{{ complaint.1 }}</td>
                    <td>{{ complaint.2 }}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editComplaint({{ complaint.0 }})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteComplaint({{ complaint.0 }})">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}


{% block script %}


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>


<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">


<!-- DataTables Buttons CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">


<!-- DataTables Buttons JS -->
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>


<!-- JSZip for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>


<!-- PDFMake for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/36.0.1/classic/ckeditor.js"></script>


<script>
    $(document).ready(function() {
        // Initialize DataTable
        $('#complaintTypesTable').DataTable({
            "paging": true,           // Enable pagination
            "lengthChange": true,     // Enable records per page selection
            "searching": true,        // Enable search functionality
            "ordering": true,         // Enable column sorting
            "info": true,             // Show information about the current page
            "autoWidth": false,       // Disable automatic column width adjustment
            "pageLength": 5,        // Set default records per page to 5
            "lengthMenu": [3, 5, 10, 25, 50, 100], // Set the records per page options
        });
    });

    

// Initialize CKEditor
let editor;
ClassicEditor
    .create(document.querySelector('#email'), {
        toolbar: [
            'heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote',
            '|', 'insertTable', 'tableColumn', 'tableRow', 'mergeTableCells', 
            '|', 'imageUpload', 'mediaEmbed', 'undo', 'redo', '|', 
        ],
        mediaEmbed: {
            previewsInData: true, // Allows embedded media previews in data
        },
        ckfinder: {
            uploadUrl: '/upload/' // Your backend URL for handling uploads
        }
    })
    .then(ed => {
        editor = ed;
    })
    .catch(error => {
        console.error(error);
    });

// Handle form submission (for adding new complaints)
document.querySelector('#complaintForm').addEventListener('submit', function (event) {
    event.preventDefault();  // Prevent default form submission

    // If in update mode, prevent the submission
    if (document.querySelector('#submitBtn').innerHTML === "Update") return;

    // Ensure CKEditor content is updated to the textarea value
    if (editor) {
        let emailContent = editor.getData();
        document.querySelector('#email').value = emailContent;  // Set the content to the textarea
    }

    // Validate the form
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;

    console.log('Form Submission:', { name, email }); // Log form data

    // Validate all fields
    if (name && email) {
        submitFormViaAjax(name, email);
    } else {
        alert('Please fill in all fields');
    }
});

// Submit form via AJAX (for adding new complaints)
const submitFormViaAjax = (name, email) => {
    const url = '{% url "signaturemaster" %}';  // Ensure this URL is correct
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const formData = {
        name: name,
        signature: email
    };

    console.log('AJAX Form Data:', formData); // Log the data being sent in AJAX request

    // Perform the AJAX request
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',  // Send data as JSON
            'X-CSRFToken': csrfToken,  // CSRF protection
        },
        body: JSON.stringify(formData)  // Send data as JSON
    })
    .then(response => response.json())
    .then(data => {
        console.log('Response Data:', data); // Log the response from the server
        if (data.message === 'Complaint submitted successfully!') {
            alert('Complaint submitted successfully!');
            addComplaintToTable(data.complaint);  // Ensure this is returned in the response
            document.getElementById('complaintForm').reset();
            editor.setData('');  // Clear CKEditor content
        } else {
            alert('There was an error submitting your complaint.');
        }
    })
    .catch(error => {
        console.error('Error during form submission:', error);
        alert('An error occurred while submitting the complaint.');
    });
};

// Function to add a complaint to the table dynamically after submission
function addComplaintToTable(complaint) {
    console.log('Adding complaint to table:', complaint); // Log the complaint being added
    let tableBody = document.querySelector('#complaintTypesTable tbody');
    let newRow = document.createElement('tr');
    newRow.setAttribute('data-id', complaint.id);
    newRow.innerHTML = `
        <td>${complaint.name}</td>
        <td>${complaint.signature}</td>
        <td>
            <button class="action-btn edit-btn" onclick="editComplaint(${complaint.id})">Edit</button>
            <button class="action-btn delete-btn" onclick="deleteComplaint(${complaint.id})">Delete</button>
        </td>
    `;
    tableBody.appendChild(newRow);
}

// Function to edit a complaint (AJAX - PUT)
function editComplaint(id) {
    console.log('Editing complaint with ID:', id); // Log the complaint ID being edited
    const url = `/edit_signature/${id}/`;  // Your edit URL
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Get current row data
    let row = document.querySelector(`#complaintTypesTable tr[data-id="${id}"]`);
    const name = row.querySelector('td:nth-child(1)').textContent;
    const email = row.querySelector('td:nth-child(2)').textContent;

    console.log('Current Row Data:', { name, email }); // Log current data for editing

    // Display current data in the form for editing
    document.getElementById('name').value = name;
    editor.setData(email);  // Set CKEditor content to the complaint's content

    // Change submit button to "Update"
    const submitButton = document.querySelector('#complaintForm button[type="submit"]');
    submitButton.textContent = "Update";

    // Handle update via AJAX
    document.querySelector('#complaintForm').onsubmit = function (event) {
        event.preventDefault();

        // Get the updated values from the form
        const updatedName = document.getElementById('name').value;
        const updatedEmail = editor.getData();

        console.log('Updated Data:', { updatedName, updatedEmail }); // Log the updated data

        const updatedData = {
            name: updatedName,
            signature: updatedEmail
        };

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify(updatedData),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Response Data from Update:', data); // Log the response after update
            if (data.message === 'Complaint updated successfully!') {
                alert('Complaint updated successfully!');
                updateComplaintRow(id, updatedData);
                document.getElementById('complaintForm').reset();
                editor.setData('');
                submitButton.textContent = "Submit";
            } else {
                alert('There was an error updating your complaint.');
            }
        })
        .catch(error => {
            console.error('Error during update:', error);
            alert('An error occurred while updating the complaint.');
        });
    };
}

// Function to update the complaint row in the table
function updateComplaintRow(id, updatedData) {
    console.log('Updating complaint row with ID:', id, 'Data:', updatedData); // Log the update
    const row = document.querySelector(`#complaintTypesTable tr[data-id="${id}"]`);
    if (row) {
        row.querySelector('td:nth-child(1)').textContent = updatedData.name;
        row.querySelector('td:nth-child(2)').innerHTML = updatedData.signature; // Ensure HTML content is updated

        console.log('Row updated successfully:', row);
    } else {
        console.log('Row not found for ID:', id);
    }
}

// Function to delete a complaint (AJAX - DELETE)
function deleteComplaint(id) {
    console.log('Deleting complaint with ID:', id); // Log the complaint ID being deleted
    const url = `/delete_signature/${id}/`;  // Your delete URL
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (confirm('Are you sure you want to delete this complaint?')) {
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Response Data from Delete:', data); // Log the response after delete
            if (data.message === 'Complaint deleted successfully!') {
                alert('Complaint deleted successfully!');
                removeComplaintFromTable(id);
            } else {
                alert('There was an error deleting your complaint.');
            }
        })
        .catch(error => {
            console.error('Error during delete:', error);
            alert('An error occurred while deleting the complaint.');
        });
    }
}

// Function to remove a complaint row from the table
function removeComplaintFromTable(id) {
    console.log('Removing complaint row with ID:', id); // Log the ID of the complaint being removed
    const row = document.querySelector(`#complaintTypesTable tr[data-id="${id}"]`);
    row.remove();
}
</script>


{% endblock %}